name: Build and Push Orbit Image (ARM64)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Version tag to use"
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: planetaryorbit/orbit

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GH_USER }}
          password: ${{ secrets.GH_PAT }}

      # Build ARM64
      - name: Build and push ARM64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version_tag }}-arm64
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64

      - name: Summary
        run: |
          echo "## ðŸŽ‰ ARM64 Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/planetaryorbit/orbit:${{ github.event.inputs.version_tag }}-arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm64 (Apple Silicon, ARM) âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- linux/amd64 (Intel/AMD) âš ï¸ Run 'Build Orbit (AMD64)' workflow manually with version: \`${{ github.event.inputs.version_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Notes" >> $GITHUB_STEP_SUMMARY
          echo "Run the AMD64 workflow with the same version tag to create multi-platform manifest." >> $GITHUB_STEP_SUMMARY
